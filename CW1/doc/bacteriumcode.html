<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>BEAST - Bioinspired Evolutionary Agent Simulation Toolkit: Bacterium source code</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.2 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="modules.html">Modules</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Compound&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Compound&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1><a name="bacteriumcode">Bacterium source code</a>
</h1><div class="fragment"><pre><span class="preprocessor">#include "<a class="code" href="bacterium_8h.html">bacterium.h</a>"</span>

<span class="keyword">using</span> <span class="keyword">namespace </span>std;

<span class="keyword">namespace </span>BEAST {

Bacterium::Bacterium():
reproductionCost(0.4), 
energyRate(0.005), 
sporeEnergyRate(0.01),
attractantCost(0.01), repellentCost(0.01),
deathThreshold(0.0),
tumbleTime(10.0), tumbleScale(10.0),
reproductionThreshold(0.4), 
sporulationThreshold(0.25),
consumptionRate(0.1), attractantRate(0.5), repellentRate(4.0),
swarmRadius(20.0), swarmInfluence(0.5), 
gradientInfluence(0.8),
nutrientResponse(0.8), attractantResponse(0.8), repellentResponse(0.8),
attractantThreshold(0.5), repellentThreshold(0.5),
nutrientDist(NULL), attractantDist(NULL), 
repellentDist(NULL), trailDist(NULL),
energy(1.0), totalEnergy(0.1), lastNutrient(0.0),
currentNutrient(0.0), currentAttractant(0.0), currentRepellent(0.0),
nextCheck(0), swarmSize(0)
{
    SetInitRandom(<span class="keyword">true</span>);
    SetSpeed(40.0);
}

Bacterium::~Bacterium()
{
    for_each(offspring.begin(), offspring.end(), deleter&lt;Bacterium&gt;());
}

<span class="keywordtype">void</span> Bacterium::Update()
{
    CheckBoundary();
    ReadDistributions();
    UpdateDistributions();

    SetVelocity((1.0 - gradientInfluence) * GetVelocity() + 
             gradientInfluence * 
             ( nutrientResponse * GetNutrientGradient()
             + attractantResponse * GetAttractantGradient()
             - repellentResponse * GetRepellentGradient()));
    SetVelocity((1.0 - swarmInfluence) * GetVelocity()
             + swarmInfluence * GetSwarmVelocity());

    GetVelocity().SetLength(GetMaxSpeed());

    UpdateEnergy();

    <span class="comment">// Apply velocity changes and clean up.</span>
    FinishUpdate();
}

<span class="keywordtype">void</span> Bacterium::CheckBoundary()
{
    <span class="keywordflow">if</span> (GetLocation().x &lt;= 0.0) {
        SetVelocityX(-GetVelocity().x);
        SetLocationX(0.0); }
    <span class="keywordflow">if</span> (GetLocation().x &gt;= GetWorld().GetWidth()) {
        SetVelocityX(-GetVelocity().x);
        SetLocationX(GetWorld().GetWidth() - 1.0); }
    <span class="keywordflow">if</span> (GetLocation().y &lt;= 0.0) {
        SetVelocityY(-GetVelocity().y);
        SetLocationY(0.0); }
    <span class="keywordflow">if</span> (GetLocation().y &gt;= GetWorld().GetHeight()) {
        SetVelocityY(-GetVelocity().y);
        SetLocationY(GetWorld().GetHeight() - 1.0); }
}

<span class="keywordtype">void</span> Bacterium::ReadDistributions()
{
    <span class="keywordflow">if</span> (nutrientDist != NULL) currentNutrient = nutrientDist-&gt;GetDensity(GetLocation());
    <span class="keywordflow">if</span> (attractantDist != NULL) currentAttractant = attractantDist-&gt;GetDensity(GetLocation());
    <span class="keywordflow">if</span> (repellentDist != NULL) currentRepellent = repellentDist-&gt;GetDensity(GetLocation());
}

<span class="keywordtype">void</span> Bacterium::UpdateDistributions()
{
    <span class="keywordflow">if</span> (nutrientDist != NULL) {

        <span class="keywordtype">double</span> amount = consumptionRate &lt;= currentNutrient ? consumptionRate : currentNutrient;
        energy += amount;
        totalEnergy += amount;
        nutrientDist-&gt;AddDensity(GetLocation(), static_cast&lt;DistReal&gt;(-amount));

        <span class="keywordflow">if</span>  (!isSpore) {
            <span class="keywordflow">if</span> (currentNutrient &gt;= attractantThreshold) ReleaseAttractant();
            <span class="keywordflow">if</span> (currentNutrient &lt; repellentThreshold) ReleaseRepellent();
        }
    }

    <span class="keywordflow">if</span> (trailDist != NULL) {
        <span class="keywordflow">if</span> (trailDist-&gt;GetDensity(GetLocation()) &lt;= 0.0) 
            trailDist-&gt;SetDensity(GetLocation(), 0.5);
    }
}

<span class="keywordtype">void</span> Bacterium::ReleaseAttractant()
{
    <span class="keywordflow">if</span> (attractantDist == NULL) <span class="keywordflow">return</span>;

    <span class="keywordtype">double</span> amount = currentNutrient * attractantRate;
    <span class="keywordtype">double</span> cost = amount * attractantCost;

    <span class="keywordflow">if</span> (energy &gt;= cost) energy -= cost;
    <span class="keywordflow">else</span> {
        amount = energy / attractantCost;
        energy = 0.0;
    }

    attractantDist-&gt;AddDensity(GetLocation(), static_cast&lt;DistReal&gt;(amount));
}

<span class="keywordtype">void</span> Bacterium::ReleaseRepellent()
{
    <span class="keywordflow">if</span> (repellentDist == NULL) <span class="keywordflow">return</span>;

    <span class="keywordtype">double</span> amount = (repellentThreshold - (repellentThreshold - currentNutrient)) 
                  / repellentThreshold * repellentRate;
    <span class="keywordtype">double</span> cost = amount * repellentCost;

    <span class="keywordflow">if</span> (energy &gt;= cost) energy -= cost;
    <span class="keywordflow">else</span> {
        <span class="comment">// If the amount is too expensive, release as much as possible.</span>
        amount = energy / repellentCost;
        energy = 0.0;
    }

    repellentDist-&gt;AddDensity(GetLocation(), static_cast&lt;DistReal&gt;(amount));
}

Vector2D Bacterium::GetSwarmVelocity()
{
    <span class="keywordflow">return</span> swarmSize &gt; 0 
        ? swarmTotalVel *= 1.0 / static_cast&lt;double&gt;(swarmSize)
        : GetVelocity();
}

Vector2D Bacterium::GetTumblingVelocity()
{
    --nextCheck;
    <span class="keywordflow">if</span> (nextCheck &lt;= 0) {
        SetNextCheck();
        <span class="keywordflow">if</span> (nextCheck &lt;= 0) tumblingVelocity.SetAngle(<a class="code" href="group__utilities.html#a4">randval</a>(TWOPI));
    }
    <span class="keywordflow">return</span> tumblingVelocity;
}

Vector2D Bacterium::GetNutrientGradient()
{
    <span class="keywordflow">return</span> nutrientDist != NULL
        ? nutrientDist-&gt;GetGradient(GetLocation()).GetNormalised()
        : Vector2D(0.0, 0.0);
}

Vector2D Bacterium::GetAttractantGradient()
{
    <span class="keywordflow">return</span> attractantDist != NULL
        ? attractantDist-&gt;GetGradient(GetLocation()).GetNormalised()
        : Vector2D(0.0, 0.0);
}

Vector2D Bacterium::GetRepellentGradient()
{
    <span class="keywordflow">return</span> repellentDist != NULL
        ? repellentDist-&gt;GetGradient(GetLocation()).GetNormalised()
        : Vector2D(0.0, 0.0);
}

<span class="keywordtype">void</span> Bacterium::UpdateEnergy()
{
    <span class="keywordflow">if</span> (!isSpore) energy -= energyRate * fabs(GetMaxSpeed());
    energy -= sporeEnergyRate;

    <span class="comment">// Sporulate depending on energy.</span>
    isSpore = energy &lt;= sporulationThreshold;

    <span class="comment">// Ensure energy never goes below </span>
    <span class="keywordflow">if</span> (energy &lt;= 0.0) energy = 0.0;

    <span class="comment">// If the energy level is below the deathThreshold, die next frame.</span>
    <span class="keywordflow">if</span> (energy &lt;= deathThreshold) {
        <span class="keywordflow">if</span> (trailDist != NULL) trailDist-&gt;SetDensity(GetLocation(), 1.0);
        SetDead(<span class="keyword">true</span>);
    }

    <span class="comment">// If there is enough energy to reproduce, do so.</span>
    <span class="keywordflow">if</span> (energy &gt;= reproductionThreshold &amp;&amp;
        energy &gt;= reproductionCost) Reproduce();
}

<span class="keywordtype">void</span> Bacterium::FinishUpdate()
{
    <span class="comment">// Update the location with the velocity.</span>
    OffsetLocation(GetVelocity() * GetTimeStep());

    swarmSize = 0;
    swarmTotalVel.x = swarmTotalVel.y = 0.0;
}

<span class="keywordtype">void</span> Bacterium::Interact(WorldObject* obj)
{
    <span class="keywordflow">if</span> (dynamic_cast&lt;Distribution*&gt;(obj)) <span class="keywordflow">return</span>;
    Animat::Interact(obj);
}

<span class="keywordtype">void</span> Bacterium::UniInteract(WorldObject* obj)
{
    Bacterium* b;
    <span class="keywordflow">if</span> (<a class="code" href="group__utilities.html#a17">IsKindOf</a>(obj, b) &amp;&amp; (b-&gt;GetLocation() - GetLocation()).GetLengthSquared()
                            &lt; (swarmRadius * swarmRadius)) {
        swarmTotalVel += b-&gt;GetVelocity();
        ++swarmSize;
    }

    Animat::UniInteract(obj);
}

<span class="keywordtype">void</span> Bacterium::SetNextCheck()
{
    <span class="keywordtype">double</span>  gradNutrient = currentNutrient - lastNutrient,
            gradAttractant = currentAttractant - lastAttractant,
            gradRepellent = currentRepellent - lastRepellent;

    nextCheck = static_cast&lt;int&gt;(tumbleTime 
                                + gradNutrient * tumbleScale * tumbleTime
                                + gradAttractant * attractantResponse * tumbleTime
                                - gradRepellent * repellentResponse * tumbleTime);

    lastNutrient = currentNutrient;
}

<span class="keywordtype">void</span> Bacterium::Reproduce()
{
    energy -= reproductionCost;
    energy /= 2.0;
    Bacterium* baby = <span class="keyword">new</span> Bacterium(*<span class="keyword">this</span>);

    <span class="keywordtype">double</span> o = <a class="code" href="group__utilities.html#a4">randval</a>(TWOPI);
    SetLocation(Vector2D(GetLocation(), GetRadius(), o));
    baby-&gt;SetLocation(Vector2D(GetLocation(), -GetRadius(), o));

    baby-&gt;Reset();
    GetWorld().Add(baby);
    offspring.push_back(baby);
}

<span class="keywordtype">void</span> Bacterium::GetOffspring(std::list&lt;Bacterium*&gt;&amp; babies)<span class="keyword">const</span>
{
    std::list&lt;Bacterium*&gt;::const_iterator i = offspring.begin();

    <span class="keywordflow">for</span> (; i != offspring.end(); ++i) {
        babies.push_back(*i);
        (*i)-&gt;GetOffspring(babies);
    }
}

std::list&lt;Bacterium*&gt; Bacterium::GetOffspring()<span class="keyword">const</span>
{
    std::list&lt;Bacterium*&gt; result;
    GetOffspring(result);
    <span class="keywordflow">return</span> result;
}

<span class="keywordtype">void</span> Bacterium::GetOffspring(std::list&lt;Bacterium const*&gt;&amp; babies)<span class="keyword">const</span>
{
    std::list&lt;Bacterium*&gt;::const_iterator i = offspring.begin();

    <span class="keywordflow">for</span> (; i != offspring.end(); ++i) {
        babies.push_back(*i);
        (*i)-&gt;GetOffspring(babies);
    }
}

string Bacterium::ToString()<span class="keyword">const</span>
{
    ostringstream out;
    out &lt;&lt; <span class="stringliteral">"N: "</span> &lt;&lt; currentNutrient &lt;&lt; <span class="stringliteral">" A: "</span> &lt;&lt; currentAttractant
        &lt;&lt; <span class="stringliteral">" R: "</span> &lt;&lt; currentRepellent &lt;&lt; <span class="stringliteral">" E: "</span> &lt;&lt; energy
        &lt;&lt; <span class="stringliteral">" T: "</span> &lt;&lt; totalEnergy;
    <span class="keywordflow">return</span> out.str();
}

<span class="keywordtype">void</span> Bacterium::OnClick()
{
    GetLogStream()
    &lt;&lt; <span class="stringliteral">"Reproduction threshold: "</span>   &lt;&lt; reproductionThreshold &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Consumption rate: "</span>         &lt;&lt; consumptionRate &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Attractant rate: "</span>          &lt;&lt; attractantRate &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Repellent rate: "</span>           &lt;&lt; repellentRate &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Swarm radius: "</span>             &lt;&lt; swarmRadius &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Swarm influence: "</span>          &lt;&lt; swarmInfluence &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Gradient influence: "</span>       &lt;&lt; gradientInfluence &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Nutrient response: "</span>        &lt;&lt; nutrientResponse &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Attractant response: "</span>      &lt;&lt; attractantResponse &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Repellent response: "</span>       &lt;&lt; repellentResponse &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Attractant threshold: "</span>     &lt;&lt; attractantThreshold &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Repellent threshold: "</span>      &lt;&lt; repellentThreshold &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Radius: "</span>                   &lt;&lt; GetRadius() &lt;&lt; <span class="charliteral">'\n'</span>
    &lt;&lt; <span class="stringliteral">"Speed: "</span>                    &lt;&lt; GetSpeed() &lt;&lt; <span class="stringliteral">"\n\n"</span>;
}

} <span class="comment">// namespace BEAST</span>
</pre></div> <hr size="1"><address style="align: right;"><small>Generated on Sun Feb 1 21:26:30 2004 for BEAST - Bioinspired Evolutionary Agent Simulation Toolkit by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.2 </small></address>
</body>
</html>
